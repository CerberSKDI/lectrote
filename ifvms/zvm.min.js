/* ZVM v1.0.0 https://github.com/curiousdannii/ifvms.js */
!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var i;i="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,i.ZVM=t()}}(function(){return function t(i,e,s){function n(o,h){if(!e[o]){if(!i[o]){var u="function"==typeof require&&require;if(!h&&u)return u(o,!0);if(r)return r(o,!0);var a=new Error("Cannot find module '"+o+"'");throw a.code="MODULE_NOT_FOUND",a}var c=e[o]={exports:{}};i[o][0].call(c.exports,function(t){var e=i[o][1][t];return n(e?e:t)},c,c.exports,t,i,e,s)}return e[o].exports}for(var r="function"==typeof require&&require,o=0;o<s.length;o++)n(s[o]);return n}({1:[function(t,i,e){"use strict";function s(t,i,e){return e=e||{},i&&(e.func=i),t.subClass(e)}var n=t("../common/utils.js"),r=n.Class,o=n.U2S16,h=r.subClass({init:function(t,i){this.e=t,this.v=i},toString:function(){return this.v},U2S:function(){return o(this.v)}}),u=h.subClass({toString:function(){var t=this.v;return this.indirect?"e.indirect("+t+")":0===t?"s.pop()":--t<15?"l["+t+"]":"e.m.getUint16("+(this.e.globals+2*(t-15))+")"},store:function(t){var i=this.v;return this.indirect?"e.indirect("+i+","+t+")":this.returnval?"e.variable("+i+","+t+")":0===i?"s.push("+t+")":--i<15?"l["+i+"]="+t:"e.ram.setUint16("+(this.e.globals+2*(i-15))+","+t+")"},U2S:function(){return"e.U2S("+this+")"}}),a=r.subClass({init:function(t,i,e,s,n,r){this.e=t,this.context=i,this.code=e,this.pc=s,this.labels=[this.pc+"/"+this.code],this.next=n,this.operands=r,this.post&&this.post()},toString:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(t){return this.operands.join(t)},label:function(){return"/* "+this.labels.join()+" */ "}}),c=a.subClass({stopper:1}),l=c.subClass({post:function(){this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return"e.stop=1;e.pc="+this.next+";"+this.origfunc.apply(this,arguments)}}),f=l.subClass({storer:1,post:function(){this.storer=this.operands.pop(),this.origfunc=this.func,this.func=this.newfunc}}),p=r.subClass({init:function(t,i){this.ops=t||[],this.code=i||"||"},toString:function(){for(var t,i=0,e=[];i<this.ops.length;)t=this.ops[i++],e.push(t.func?(t.iftrue?"":"!(")+t.func.apply(t,t.operands)+(t.iftrue?"":")"):t);return(this.invert?"(!(":"(")+e.join(this.code)+(this.invert?"))":")")}}),g=a.subClass({brancher:1,keyword:"if",post:function(){var t,i,e=this.operands.pop(),s=e[1];this.iftrue=e[0],0===s||1===s?t="e.ret("+s+")":(s+=this.next-2,this.context.targets.push(s),t="e.pc="+s),this.result=t+";return",this.offset=s,this.cond=new p([this]),this.context.ops.length&&(i=this.context.ops.pop(),i.offset===s?(this.cond.ops.unshift(i.cond),this.labels=i.labels,this.labels.push(this.pc+"/"+this.code)):this.context.ops.push(i))},toString:function(){var t=this.result;return t instanceof v&&(this.e.env.debug&&(t.context=this.context),t+=t.stopper?"; return":"",this.result.ops.length>1&&(t="\n"+t+"\n",this.e.env.debug&&(t+=this.context.spacer))),this.label()+this.keyword+this.cond+" {"+t+"}"}}),_=g.subClass({storer:1,post:function(){_.super.post.call(this),this.storer=this.operands.pop(),this.storer.returnval=1,this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return this.storer.store(this.origfunc.apply(this,arguments))}}),d=a.subClass({storer:1,post:function(){this.storer=this.operands.pop()},toString:function(){var t=d.super.toString.call(this);return this.storer?this.storer.store(t):t}}),m=c.subClass({result:{v:-1},toString:function(){return this.label()+"e.call("+this.operands.shift()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),U=m.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),v=r.subClass({init:function(t,i){this.e=t,this.pc=i,this.pre=[],this.ops=[],this.post=[],this.targets=[],t.env.debug&&(this.spacer="")},toString:function(){return this.e.env.debug?(this.context&&(this.spacer=this.context.spacer+"  "),this.pre.join("")+(this.ops.length>1?this.spacer:"")+this.ops.join(";\n"+this.spacer)+this.post.join("")):this.pre.join("")+this.ops.join(";")+this.post.join("")}}),w=v.subClass({toString:function(){return this.pre.unshift("var l=e.l,s=e.s;\n"),w.super.toString.call(this)}});i.exports={Operand:h,Variable:u,Opcode:a,Stopper:c,Pauser:l,PauserStorer:f,BrancherLogic:p,Brancher:g,BrancherStorer:_,Storer:d,Caller:m,CallerStorer:U,Context:v,RoutineContext:w,opcode_builder:s}},{"../common/utils.js":3}],2:[function(t,i,e){"use strict";function s(t){var i,e,s,n=r(t);if("FORM"===n.getFourCC(0)&&"IFRS"===n.getFourCC(8)?(i=new h(t),i.exec&&(e=i.exec.type,t=i.exec.data,"GLUL"===e&&(n=r(t),s=n.getUint32(4)),"ZCOD"===e&&(s=t[0]))):"Glul"===n.getFourCC(0)?(e="GLUL",s=n.getUint32(4)):(s=n.getUint8(0),s>0&&s<9&&(e="ZCOD")),e&&s)return{format:e,version:s,data:t}}var n=t("./utils.js"),r=n.MemoryView,o=n.Class.subClass({init:function(t){if(this.type="",this.chunks=[],t){var i,e,s=r(t),n=12;if("FORM"!==s.getFourCC(0))throw new Error("Not an IFF file");for(this.type=s.getFourCC(8),i=s.getUint32(4)+8;n<i;){if(e=s.getUint32(n+4),e<0||e+n>i)throw new Error("IFF chunk out of range");this.chunks.push({type:s.getFourCC(n),offset:n,data:s.getUint8Array(n+8,e)}),n+=8+e,e%2&&n++}}},write:function(){for(var t,i,e=12,s=0,n=12;s<this.chunks.length;)this.chunks[s].data.buffer&&(this.chunks[s].data=this.chunks[s].data.buffer),this.chunks[s].length=this.chunks[s].data.byteLength||this.chunks[s].data.length,e+=8+this.chunks[s++].length,e%2&&e++;for(t=r(e),t.setFourCC(0,"FORM"),t.setUint32(4,e-8),t.setFourCC(8,this.type),s=0;s<this.chunks.length;)i=this.chunks[s++],t.setFourCC(n,i.type),t.setUint32(n+4,i.length),t.setUint8Array(n+8,i.data),n+=8+i.length,n%2&&n++;return t.buffer}}),h=o.subClass({init:function(t){if(this.super.init.call(this,t),t){if("IFRS"!==this.type)throw new Error("Not a Blorb file");if("RIdx"!==this.chunks[0].type)throw new Error("Malformed Blorb: chunk 1 is not RIdx");for(var i=r(this.chunks[0].data),e=4;e<this.chunks[0].data.length;){if("Exec"===i.getFourCC(e)&&0===i.getUint32(e+4))return void(this.exec=this.chunks.filter(function(t){return t.offset===i.getUint32(e+8)})[0]);e+=12}}}}),u=o.subClass({init:function(t){if(this.super.init.call(this,t),t){if("IFZS"!==this.type)throw new Error("Not a Quetzal savefile");for(var i,e,s,n=0;n<this.chunks.length;)i=this.chunks[n].type,e=this.chunks[n++].data,"CMem"===i||"UMem"===i?(this.memory=e,this.compressed="CMem"===i):"Stks"===i?this.stacks=e:"IFhd"===i&&(s=r(e.buffer),this.release=s.getUint16(0),this.serial=s.getUint8Array(2,6),this.checksum=s.getUint16(8),this.pc=16777215&s.getUint32(9))}},write:function(){this.type="IFZS";var t=r(13);return t.setUint16(0,this.release),t.setUint8Array(2,this.serial),t.setUint32(9,this.pc),t.setUint16(8,this.checksum),this.chunks=[{type:"IFhd",data:t},{type:this.compressed?"CMem":"UMem",data:this.memory},{type:"Stks",data:this.stacks}],this.super.write.call(this)}});i.exports={IFF:o,Blorb:h,Quetzal:u,identify:s}},{"./utils.js":3}],3:[function(t,i,e){"use strict";function s(){for(var t,i,e=arguments[0],s=1;s<arguments.length;){t=arguments[s++];for(i in t)e[i]=t[i]}return e}function n(){}function r(t,i,e){return"number"==typeof t&&(t=new ArrayBuffer(t)),t.buffer&&(t=t.buffer),s(new DataView(t,i,e),{getUint8Array:function(t,i){return new Uint8Array(this.buffer.slice(t,t+i))},getUint16Array:function(t,i){return u(new Uint8Array(this.buffer,t,2*i))},setUint8Array:function(t,i){i instanceof ArrayBuffer&&(i=new Uint8Array(i)),new Uint8Array(this.buffer).set(i,t)},getFourCC:function(t){return String.fromCharCode(this.getUint8(t),this.getUint8(t+1),this.getUint8(t+2),this.getUint8(t+3))},setFourCC:function(t,i){this.setUint8(t,i.charCodeAt(0)),this.setUint8(t+1,i.charCodeAt(1)),this.setUint8(t+2,i.charCodeAt(2)),this.setUint8(t+3,i.charCodeAt(3))}})}function o(t){return t<<16>>16}function h(t){return 65535&t}function u(t){for(var i=0,e=t.length,s=new Uint16Array(e/2);i<e;)s[i/2]=t[i++]<<8|t[i++];return s}n.subClass=function(t){function i(){this.init&&this.init.apply(this,arguments)}return i.prototype=s(Object.create(this.prototype),t),i.subClass=this.subClass,i.super=i.prototype.super=this.prototype,i},i.exports={extend:s,Class:n,MemoryView:r,U2S16:o,S2U16:h,Uint8toUint16Array:u}},{}],4:[function(t,i,e){"use strict";var s=t("./common/utils.js"),n=t("./common/file.js"),r=s.MemoryView,o={init:function(){this.jit={},this.init=this.start},prepare:function(t,i){if(!i.Glk)throw new Error("A reference to Glk is required");this.Glk=i.Glk,this.data=t,this.env=i},start:function(){var t,i=this.Glk;try{if(t=n.identify(this.data),delete this.data,!t||"ZCOD"!==t.format)throw new Error("This is not a Z-Code file");if(3!==t.version&&5!==t.version&&8!==t.version)throw new Error("Unsupported Z-Machine version: "+t.version);this.m=r(t.data),this.staticmem=this.m.getUint16(14),this.ram=r(this.m.buffer,0,this.staticmem),this.origram=this.m.getUint8Array(0,this.staticmem),this.restart(),this.run(),this.quit||(this.glk_event=new i.RefStruct,this.glk_blocking_call?this.glk_event.push_field(this.glk_blocking_call):i.glk_select(this.glk_event),i.update())}catch(t){throw t instanceof Error&&(t.message="ZVM start: "+t.message),i.fatal_error(t),t}},resume:function(t){var i,e,s=this.Glk,n=this.glk_event;try{i=n.get_field(0),2===i&&(this.handle_char_input(n.get_field(2)),e=1),3===i&&(this.handle_line_input(n.get_field(2),n.get_field(3)),e=1),5===i&&this.update_width(),"fileref_create_by_prompt"===i&&(e=this.handle_create_fileref(t)),this.glk_blocking_call=null,e&&this.run(),this.quit||(this.glk_event=new s.RefStruct,this.glk_blocking_call?this.glk_event.push_field(this.glk_blocking_call):s.glk_select(this.glk_event),s.update())}catch(t){throw t instanceof Error&&(t.message="ZVM: "+t.message),s.fatal_error(t),t}},get_signature:function(){for(var t=[],i=0;i<30;)t.push((this.origram[i]<16?"0":"")+this.origram[i++].toString(16));return t.join("")},run:function(){var t,i;for(this.stop=0;!this.stop;)t=this.pc,this.jit[t]||this.compile(),i=this.jit[t](this),isNaN(i)||this.ret(i)},compile:function(){var t=this.disassemble();this.jit[t.pc]=new Function("e",""+t),t.pc<this.staticmem&&this.log("Caching a JIT function in dynamic memory: "+t.pc)}},h=s.Class.subClass(s.extend(o,t("./zvm/runtime.js"),t("./zvm/text.js"),t("./zvm/io.js"),t("./zvm/disassembler.js")));i.exports=h},{"./common/file.js":2,"./common/utils.js":3,"./zvm/disassembler.js":5,"./zvm/io.js":6,"./zvm/runtime.js":8,"./zvm/text.js":9}],5:[function(t,i,e){var s=t("../common/ast.js");i.exports.disassemble=function(){function t(t,i){for(var e=0;e<4;e++)i.push((192&t)>>6),t<<=2}for(var i,e,n,r,o,h,u,a=this.m,c=this.opcodes,l=new s.RoutineContext(this,this.pc);;){if(e=i=this.pc,r=a.getUint8(i++),190===r?(h=-1,r=a.getUint8(i++)+1e3):128&r?64&r?(h=-1,32&r||(r&=31)):(h=[(48&r)>>4],h[0]<3&&(r&=207)):(h=[64&r?2:1,32&r?2:1],r&=31),!c[r])throw this.log(""+l),this.stop=1,new Error("Unknown opcode #"+r+" at pc="+e);for(o=c[r].prototype,h===-1&&(h=[],t(a.getUint8(i++),h),236!==r&&250!==r||t(a.getUint8(i++),h)),u=[],n=0;n<h.length;)0===h[n]&&(u.push(new s.Operand(this,a.getUint16(i))),i+=2),1===h[n]&&u.push(new s.Operand(this,a.getUint8(i++))),2===h[n++]&&u.push(new s.Variable(this,a.getUint8(i++)));if(o.storer&&u.push(new s.Variable(this,a.getUint8(i++))),o.brancher&&(n=a.getUint8(i++),u.push([128&n,64&n?63&n:(n<<8|a.getUint8(i++))<<18>>18])),o.printer)for(u.push(i);i<this.eof&&(n=a.getUint8(i),i+=2,!(128&n)););if(this.pc=i,l.ops.push(new c[r](this,l,r,e,i,u)),n=0,o.stopper&&!n)break}return l}},{"../common/ast.js":1}],6:[function(t,i,e){"use strict";var s=t("../common/utils.js"),n=s.U2S16,r=function(){for(var t={4294967289:8,4294967290:13,4294967288:27,4294967292:129,4294967291:130,4294967294:131,4294967293:132,4294967283:146,4294967285:148,4294967284:152,4294967286:154},i=0;i<12;)t[4294967279-i]=133+i++;return t}(),o=[[0,2,1,7,4,7,5,7,9,10,6,3,6,3,6,3],[0,0,1,1,4,4,5,5,9,9,6,6,3,3,7,7]];i.exports={init_io:function(){this.io={reverse:0,bold:0,italic:0,mono:2&this.m.getUint8(17),transcript:1&this.m.getUint8(17),streams:[0,1,{},[],{}],currentwin:0,width:0,height:0,row:0,col:0},this.mainwin||(this.mainwin=this.Glk.glk_window_open(0,0,0,3,201),this.version3&&(this.statuswin=this.Glk.glk_window_open(this.mainwin,18,1,4,202))),this.set_window(0)},erase_line:function(t){if(1===t){var i=this.io,e=i.row,s=i.col;this._print(Array(i.width-i.col+1).join(" ")),this.set_cursor(e,s)}},erase_window:function(t){t<1&&this.Glk.glk_window_clear(this.mainwin),1!==t&&t!==-2||this.upperwin&&(this.Glk.glk_window_clear(this.upperwin),this.set_cursor(0,0)),t===-1&&this.split_window(0)},fileref_create_by_prompt:function(t){"undefined"==typeof t.run&&(t.run=1),this.fileref_data=t,this.glk_blocking_call="fileref_create_by_prompt",this.Glk.glk_fileref_create_by_prompt(t.usage,t.mode,t.rock||0)},format:function(){this.Glk.glk_set_style(o[this.io.currentwin][!!this.io.mono|this.io.italic|this.io.bold|this.io.reverse])},get_cursor:function(t){this.ram.setUint16(t,this.io.row+1),this.ram.setUint16(t+2,this.io.col+1)},handle_char_input:function(t){var i=this.io.streams[4],e=r[t]||this.reverse_unicode_table[t]||63;this.variable(this.read_data.storer,e),1===i.mode&&(i.cache+=e),2===i.mode&&this.Glk.glk_put_char_stream_uni(i.str,e)},handle_create_fileref:function(t){var i,e=this.Glk,s=this.fileref_data;return t&&(i=s.unicode?e.glk_stream_open_file_uni(t,s.mode,s.rock||0):e.glk_stream_open_file(t,s.mode,s.rock||0),e.glk_fileref_destroy(t)),"restore"!==s.func&&"save"!==s.func||this.save_restore_handler(i),"input_stream"===s.func&&(this.io.streams[0]=i),"output_stream"===s.func&&this.output_stream_handler(i),s.run},handle_line_input:function(t,i){var e=this.ram,s=this.read_data,n=this.io.streams,r=String.fromCharCode.apply(null,s.buffer.slice(0,t))+"\n",o=this.text_to_zscii(r.slice(0,-1).toLowerCase());1===n[2].mode&&(n[2].cache+=r),2===n[2].mode&&this.Glk.glk_put_jstring_stream(n[2].str,r),1===n[4].mode&&(n[4].cache+=r),2===n[4].mode&&this.Glk.glk_put_jstring_stream(n[4].str,r),this.version3?(o.push(0),e.setUint8Array(s.bufaddr+1,o)):(e.setUint8(s.bufaddr+1,t),e.setUint8Array(s.bufaddr+2,o),this.variable(s.storer,isNaN(i)?13:i)),s.parseaddr&&this.tokenise(s.bufaddr,s.parseaddr)},input_stream:function(t){var i=this.io;t&&!i.streams[0]&&this.fileref_create_by_prompt({func:"input_stream",mode:2,rock:212,unicode:1,usage:259}),!t&&i.streams[0]&&(this.Glk.glk_stream_close(i.streams[0]),i.streams[0]=0)},output_stream:function(t,i,e){var s,r,o=this.ram,h=this.io.streams;t=n(t),1===t&&(h[1]=1),t===-1&&(h[1]=0),2!==t||h[2].mode||(this.fileref_create_by_prompt({func:"output_stream",mode:5,rock:210,run:!e,str:2,unicode:1,usage:258}),h[2].cache="",h[2].mode=1,e||(this.stop=1)),t===-2&&(o.setUint8(17,254&o.getUint8(17)),2===h[2].mode&&this.Glk.glk_stream_close(h[2].str),h[2].mode=this.io.transcript=0),3===t&&h[3].unshift([i,""]),t===-3&&(s=h[3].shift(),r=this.text_to_zscii(s[1]),o.setUint16(s[0],r.length),o.setUint8Array(s[0]+2,r)),4!==t||h[4].mode||(this.fileref_create_by_prompt({func:"output_stream",mode:5,rock:211,str:4,unicode:1,usage:259}),h[4].cache="",h[4].mode=1,this.stop=1),t===-4&&(2===h[4].mode&&this.Glk.glk_stream_close(h[4].str),h[4].mode=0)},output_stream_handler:function(t){var i=this.ram,e=this.io.streams,s=this.fileref_data;2===s.str&&(i.setUint8(17,254&i.getUint8(17)|(t?1:0)),t?(e[2].mode=2,e[2].str=t,this.io.transcript=1,e[2].cache&&this.Glk.glk_put_jstring_stream(e[2].str,e[2].cache)):e[2].mode=this.io.transcript=0),4===s.str&&(t?(e[4].mode=2,e[4].str=t,e[4].cache&&this.Glk.glk_put_jstring_stream(e[4].str,e[4].cache)):e[4].mode=0)},_print:function(t){var i=this.Glk,e=this.io,s=0;if(e.streams[3].length)e.streams[3][0][1]+=t;else if(t=t.replace(/\r/g,"\n"),(1&this.m.getUint8(17))!==e.transcript&&this.output_stream(e.transcript?-2:2,0,1),(2&this.m.getUint8(17))!==(2&e.mono)&&(e.mono^=2,this.format()),e.currentwin)for(;s<t.length&&e.row<e.height;)i.glk_put_jstring(t[s++]),e.col++,e.col===e.width&&(e.col=0,e.row++);else e.streams[1]&&i.glk_put_jstring(t),1===e.streams[2].mode&&(e.streams[2].cache+=t),2===e.streams[2].mode&&i.glk_put_jstring_stream(e.streams[2].str,t)},print:function(t,i){var e,s;if(0===t&&(s=i),1===t&&(s=String.fromCharCode(i)),2===t&&(s=this.jit[i]||this.decode(i)),3===t&&(e=this.m.getUint16(this.objects+(this.version3?9:14)*i+(this.version3?7:12)),s=this.decode(e+1,2*this.m.getUint8(e))),4===t){if(!this.unicode_table[i])return;s=this.unicode_table[i]}this._print(""+s)},print_table:function(t,i,e,s){e=e||1,s=s||0;for(var n=0;n++<e;)this._print(this.zscii_to_text(this.m.getUint8Array(t,i))+(n<e?"\r":"")),t+=i+s},process_colours:function(){},read:function(t,i,e,s,n){var r,o,h=this.m.getUint8(i),u=0;if(this.version3&&(h++,this.v3_status()),r=Array(h),this.read_data={buffer:r,bufaddr:i,parseaddr:e,routine:n,storer:t,time:s},this.io.streams[0]){if(o=this.Glk.glk_get_line_stream_uni(this.io.streams[0],r),10===r[o-1]&&o--,o)return this._print(String.fromCharCode.apply(null,r.slice(0,o))+"\n"),this.handle_line_input(o),this.stop=0;this.input_stream(0)}this.Glk.glk_request_line_event_uni(this.mainwin,r,u)},read_char:function(t,i,e,s){if(this.io.streams[0]){var n=this.Glk.glk_get_char_stream_uni(this.io.streams[0]);if(n!==-1)return this.variable(t,n),this.stop=0;this.input_stream(0)}this.read_data={routine:s,storer:t,time:e},this.Glk.glk_request_char_event_uni(this.mainwin)},set_colour:function(){},set_cursor:function(t,i){var e=this.io;t>=e.height&&this.split_window(t+1),this.upperwin&&t>=0&&i>=0&&i<e.width&&(this.Glk.glk_window_move_cursor(this.upperwin,i,t),e.row=t,e.col=i)},set_font:function(t){if(1!==t&&4!==t)return 0;var i=4&this.io.mono?4:1;return t!==i&&(this.io.mono^=4,this.format()),i},set_style:function(t){var i=this.io;0===t&&(i.reverse=i.bold=i.italic=0,i.mono&=254),1&t&&(i.reverse=8),2&t&&(i.bold=4),4&t&&(i.italic=2),8&t&&(i.mono|=1),this.format()},set_true_colour:function(){},set_window:function(t){this.io.currentwin=t,t&&this.set_cursor(0,0),this.Glk.glk_set_window(this.upperwin&&t?this.upperwin:this.mainwin),this.format()},split_window:function(t){var i=this.Glk;0===t&&this.upperwin?(i.glk_window_close(this.upperwin),this.upperwin=null,this.io.height=0):this.upperwin||(this.upperwin=i.glk_window_open(this.mainwin,18,t,4,203)),t&&this.upperwin&&(i.glk_window_set_arrangement(i.glk_window_get_parent(this.upperwin),18,t,null),this.io.height=t,this.io.row>=t&&this.set_cursor(0,0),this.version3&&i.glk_window_clear(this.upperwin))},update_header:function(){var t=this.ram;return this.xorshift_seed=0,this.update_width(),this.version3?t.setUint8(1,143&t.getUint8(1)|(this.statuswin?32:16)|64):(t.setUint8(1,28),t.setUint8(17,87&t.getUint8(17)),t.setUint8(32,255),t.setUint16(36,255),t.setUint16(38,257),t.setUint16(50,258),void this.extension_table(4,0))},update_width:function(){var t,i=this.Glk,e=i.glk_window_open(this.mainwin,18,0,4,204),s=new i.RefBox;i.glk_window_get_size(e||this.mainwin,s),e&&i.glk_window_close(e),this.io.width=t=s.get_value(),this.version3||(this.ram.setUint8(33,t),this.ram.setUint16(34,t)),this.io.col>=t&&(this.io.col=t-1)},v3_status:function(){if(this.statuswin){var t,i=this.Glk,e=this.m,s=this.io.width,n=e.getUint16(this.globals+2),r=e.getUint16(this.globals+4),h=e.getUint16(this.objects+9*e.getUint16(this.globals)+7),u=""+this.decode(h+1,2*e.getUint8(h));t=2&e.getUint8(1)?"Time: "+(n%12===0?12:n%12)+":"+(r<10?"0":"")+r+" "+(n>11?"PM":"AM"):"Score: "+n+"  Turns: "+r,i.glk_set_window(this.statuswin),i.glk_window_move_cursor(this.statuswin,0,0),i.glk_set_style(o[1][8]),i.glk_put_jstring(Array(s+1).join(" ")),i.glk_window_move_cursor(this.statuswin,0,0),i.glk_put_jstring(" "+u.slice(0,s-t.length-4)),i.glk_window_move_cursor(this.statuswin,s-t.length-1,0),i.glk_put_jstring(t),i.glk_set_style(0),i.glk_set_window(this.upperwin&&this.io.currentwin?this.upperwin:this.mainwin)}}}},{"../common/utils.js":3}],7:[function(t,i,e){"use strict";var s=t("../common/ast.js"),n=s.Variable,r=s.Opcode,o=s.Stopper,h=s.Pauser,u=s.PauserStorer,a=s.Brancher,c=s.BrancherStorer,l=s.Storer,f=s.Caller,p=s.CallerStorer,g=s.opcode_builder,_=function(t){return""+t},d=new n(this.e,0),m=g(a,function(){return 1}),U=g(l,function(t){return"e.S2U(~"+t+")"}),v=l.subClass({storer:0,post:function(){var t=this.operands,i=t[0],e=i instanceof n;t[0]=new n(this.e,e?i:i.v),(e||0===i.v)&&(t[0].indirect=1),this.storer=142===this.code?t.pop():t.shift(),0===t.length&&t.push(d)},func:_}),w=r.subClass({func:function(t){var i=t.v-1,e=this.code%2?1:-1;return t instanceof n||i>14?"e.incdec("+t+","+e+")":(i<0?"e.s[e.s.length-1]=e.S2U(e.s[e.s.length-1]+":"e.l["+i+"]=e.S2U(e.l["+i+"]+")+e+")"}}),b=o.subClass({brancher:1,toString:function(){return"e."+(181===this.code?"save":"restore")+"("+(this.pc+1)+")"}});i.exports=function(t){return{1:g(a,function(){return 2===arguments.length?this.args("==="):"e.jeq("+this.args()+")"}),2:g(a,function(t,i){return t.U2S()+"<"+i.U2S()}),3:g(a,function(t,i){return t.U2S()+">"+i.U2S()}),4:g(a,function(t,i){return"e.U2S(e.incdec("+t+",-1))<"+i.U2S()}),5:g(a,function(t,i){return"e.U2S(e.incdec("+t+",1))>"+i.U2S()}),6:g(a,function(){return"e.jin("+this.args()+")"}),7:g(a,function(){return"e.test("+this.args()+")"}),8:g(l,function(){return this.args("|")}),9:g(l,function(){return this.args("&")}),10:g(a,function(){return"e.test_attr("+this.args()+")"}),11:g(r,function(){return"e.set_attr("+this.args()+")"}),12:g(r,function(){return"e.clear_attr("+this.args()+")"}),13:v,14:g(r,function(){return"e.insert_obj("+this.args()+")"}),15:g(l,function(t,i){return"e.m.getUint16(e.S2U("+t+"+2*"+i.U2S()+"))"}),16:g(l,function(t,i){return"e.m.getUint8(e.S2U("+t+"+"+i.U2S()+"))"}),17:g(l,function(){return"e.get_prop("+this.args()+")"}),18:g(l,function(){return"e.find_prop("+this.args()+")"}),19:g(l,function(){return"e.find_prop("+this.args(",0,")+")"}),20:g(l,function(){return"e.S2U("+this.args("+")+")"}),21:g(l,function(){return"e.S2U("+this.args("-")+")"}),22:g(l,function(){return"e.S2U("+this.args("*")+")"}),23:g(l,function(t,i){return"e.S2U(parseInt("+t.U2S()+"/"+i.U2S()+"))"}),24:g(l,function(t,i){return"e.S2U("+t.U2S()+"%"+i.U2S()+")"}),25:p,26:f,27:g(r,function(){return"e.set_colour("+this.args()+")"}),28:g(o,function(t,i){return"while(e.call_stack.length>"+i+"){e.call_stack.shift()}return "+t}),128:g(a,function(t){return t+"===0"}),129:g(c,function(t){return"e.get_sibling("+t+")"}),130:g(c,function(t){return"e.get_child("+t+")"}),131:g(l,function(t){return"e.get_parent("+t+")"}),132:g(l,function(t){return"e.get_prop_len("+t+")"}),133:w,134:w,135:g(r,function(t){return"e.print(2,"+t+")"}),136:p,137:g(r,function(t){return"e.remove_obj("+t+")"}),138:g(r,function(t){return"e.print(3,"+t+")"}),139:g(o,function(t){return"return "+t}),140:g(o,function(t){return"e.pc="+t.U2S()+"+"+(this.next-2)}),141:g(r,function(t){return"e.print(2,"+t+"*"+this.e.addr_multipler+")"}),142:v.subClass({storer:1}),143:t?U:f,176:g(o,function(){return"return 1"}),177:g(o,function(){return"return 0"}),178:g(r,function(t){return"e.print(2,"+t+")"},{printer:1}),179:g(o,function(t){return"e.print(2,"+t+");e.print(1,13);return 1"},{printer:1}),180:r,181:b,182:b,183:g(o,function(){return"e.erase_window(-1);e.restart()"}),184:g(o,function(t){return"return "+t},{post:function(){this.operands.push(d)}}),185:t?g(r,function(){return"s.pop()"}):g(l,function(){return"e.call_stack.length"}),186:g(h,function(){return"e.quit=1;e.Glk.glk_exit()"}),187:g(r,function(){return"e.print(1,13)"}),188:t?g(o,function(){return"e.pc="+this.next+";e.v3_status()"}):r,189:m,191:m,224:p,225:g(r,function(t,i,e){return"e.ram.setUint16(e.S2U("+t+"+2*"+i.U2S()+"),"+e+")"}),226:g(r,function(t,i,e){return"e.ram.setUint8(e.S2U("+t+"+"+i.U2S()+"),"+e+")"}),227:g(r,function(){return"e.put_prop("+this.args()+")"}),228:t?g(h,function(){return"e.read(0,"+this.args()+")"}):g(u,function(){return"e.read("+this.storer.v+","+this.args()+")"}),229:g(r,function(t){return"e.print(4,"+t+")"}),230:g(r,function(t){return"e.print(0,"+t.U2S()+")"}),231:g(l,function(t){return"e.random("+t.U2S()+")"}),232:g(l,_,{post:function(){this.storer=d},storer:0}),233:v,234:g(r,function(t){return"e.split_window("+t+")"}),235:g(r,function(t){return"e.set_window("+t+")"}),236:p,237:g(r,function(t){return"e.erase_window("+t.U2S()+")"}),238:g(r,function(t){return"e.erase_line("+t+")"}),239:g(r,function(t,i){return"e.set_cursor("+t+"-1,"+i+"-1)"}),240:g(r,function(t){return"e.get_cursor("+t+")"}),241:g(r,function(t){return"e.set_style("+t+")"}),242:r,243:g(o,function(){return"e.pc="+this.next+";e.output_stream("+this.args()+")"}),244:g(h,function(){return"e.input_stream("+this.args()+")"}),245:r,246:g(u,function(){return"e.read_char("+this.storer.v+","+(this.args()||"1")+")"}),247:g(c,function(){return"e.scan_table("+this.args()+")"}),248:U,249:f,250:f,251:g(r,function(){return"e.tokenise("+this.args()+")"}),252:g(r,function(){return"e.encode_text("+this.args()+")"}),253:g(r,function(){return"e.copy_table("+this.args()+")"}),254:g(r,function(){return"e.print_table("+this.args()+")"}),255:g(a,function(t){return t+"<=e.call_stack[0][4]"}),1e3:g(u,function(){return"e.save("+(this.next-1)+")"}),1001:g(u,function(){return"e.restore("+(this.next-1)+")"}),1002:g(l,function(t,i){return"e.S2U(e.log_shift("+t+","+i.U2S()+"))"}),1003:g(l,function(t,i){return"e.S2U(e.art_shift("+t.U2S()+","+i.U2S()+"))"}),1004:g(l,function(t){return"e.set_font("+t+")"}),1009:g(l,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:g(r,function(){return"if(e.restore_undo())return"},{storer:1}),1011:g(r,function(t){return"e.print(1,"+t+")"}),1012:g(l,function(){return 3}),1013:g(r,function(){return"e.set_true_colour("+this.args()+")"}),1014:r.subClass({brancher:1}),1030:g(l,function(){return"e.gestalt("+this.args()+")"})}}},{"../common/ast.js":1}],8:[function(t,i,e){"use strict";var s=t("../common/utils.js"),n=s.extend,r=s.U2S16,o=s.S2U16,h=s.Uint8toUint16Array,u=t("../common/file.js");i.exports={art_shift:function(t,i){return i>0?t<<i:t>>-i},call:function(t,i,e,s){if(0===t)return i>=0&&this.variable(i,0),this.pc=e;var n,r,o=this.l.length,h=s.length;for(this.pc=t*this.addr_multipler,r=this.m.getUint8(this.pc++),s=s.slice(0,r),n=s.length;n<r;n++)s.push(this.version3?this.m.getUint16(this.pc+2*n):0);this.version3&&(this.pc+=2*r),this.l=s.concat(this.l),this.call_stack.unshift([e,i,r,this.s.length,h,o])},clear_attr:function(t,i){var e=this.objects+(this.version3?9:14)*t+i/8|0;this.ram.setUint8(e,this.m.getUint8(e)&~(128>>i%8))},copy_table:function(t,i,e){e=r(e);var s=this.ram,n=0,o=e<0;if(e=Math.abs(e),0!==i)if(o)for(;n<e;)s.setUint8(i+n,this.m.getUint8(t+n++));else s.setUint8Array(i,this.m.getUint8Array(t,e));else for(;n<e;)s.setUint8(t+n++,0)},encode_text:function(t,i,e,s){this.ram.setUint8Array(s,this.encode(this.m.getUint8Array(t+e,i)))},extension_table:function(t,i){var e=this.extension;return!e||t>this.extension_count?0:(e+=2*t,void 0===i?this.m.getUint16(e):void this.ram.setUint16(e,i))},find_prop:function(t,i,e){var s,n,r=this.m,o=this.version3,h=0,u=r.getUint16(this.objects+(o?9:14)*t+(o?7:12));for(u+=2*r.getUint8(u)+1;;){if(s=r.getUint8(u),n=s&(o?31:63),h===e)return n;if(n===i)return u+(!o&&128&s?2:1);if(n<i)return 0;h=n,o?u+=(s>>5)+2:128&s?(n=63&r.getUint8(u+1),u+=n?n+2:66):u+=64&s?3:2}},gestalt:function(t){switch(t){case 1:return 258;case 8192:return 1;case 8193:case 8194:return 2}return 0},get_child:function(t){return this.version3?this.m.getUint8(this.objects+9*t+6):this.m.getUint16(this.objects+14*t+10)},get_sibling:function(t){return this.version3?this.m.getUint8(this.objects+9*t+5):this.m.getUint16(this.objects+14*t+8)},get_parent:function(t){return this.version3?this.m.getUint8(this.objects+9*t+4):this.m.getUint16(this.objects+14*t+6)},get_prop:function(t,i){var e,s=this.m,n=this.find_prop(t,i);return n?(e=s.getUint8(n-1),s[(this.version3?e>>5:64&e)?"getUint16":"getUint8"](n)):s.getUint16(this.properties+2*(i-1))},get_prop_len:function(t){if(0===t)return 0;var i=this.m.getUint8(t-1);return this.version3?(i>>5)+1:128&i?(i&=63,0===i?64:i):64&i?2:1},incdec:function(t,i){var e,s;return 0===t?(e=o(this.s.pop()+i),this.s.push(e),e):--t<15?this.l[t]=o(this.l[t]+i):(s=this.globals+2*(t-15),e=this.m.getUint16(s)+i,this.ram.setUint16(s,e),e)},indirect:function(t,i){return 0===t?arguments.length>1?this.s[this.s.length-1]=i:this.s[this.s.length-1]:this.variable(t,i)},insert_obj:function(t,i){this.remove_obj(t),this.set_family(t,i,i,t,t,this.get_child(i))},jeq:function(){for(var t=1;t<arguments.length;)if(arguments[t++]===arguments[0])return 1},jin:function(t,i){return this.get_parent(t)===i},log:function(t){this.env.GlkOte&&this.env.GlkOte.log(t)},log_shift:function(t,i){return i>0?t<<i:t>>>-i},put_prop:function(t,i,e){var s,n=this.find_prop(t,i);n&&(s=this.m.getUint8(n-1),this.ram[(this.version3?s>>5:64&s)?"setUint16":"setUint8"](n,e))},random:function(t){var i=this.xorshift_seed;return t<1?(this.xorshift_seed=t,0):0===i?1+Math.random()*t|0:(i^=i<<13,i^=i>>17,this.xorshift_seed=i^=i<<5,1+(32767&i)%t)},remove_obj:function(t){var i,e,s,n=this.get_parent(t);if(0!==n)if(i=this.get_child(n),e=this.get_sibling(t),i===t)this.set_family(t,0,n,e);else{for(;;){if(s=this.get_sibling(i),s===t)break;i=s}this.set_family(t,0,0,0,i,e)}},restart:function(){var i=this.ram,e=i.getUint8(0),s=3===e,r=s?2:5===e?4:8,o=i.getUint8(17),h=i.getUint16(10),u=i.getUint16(54);i.setUint8Array(0,this.origram),i.setUint8(17,o),n(this,{s:[],l:[],call_stack:[],undo:[],glk_blocking_call:null,version:e,version3:s,pc:i.getUint16(6),properties:h,objects:h+(s?53:112),globals:i.getUint16(12),eof:(i.getUint16(26)||65536)*r,extension:u,extension_count:u?i.getUint16(u):0,addr_multipler:r,opcodes:t("./opcodes.js")(s)}),this.init_text(),this.init_io(),this.update_header()},restore:function(t){this.pc=t,this.fileref_create_by_prompt({func:"restore",mode:2,usage:1})},restore_file:function(t){var i,e,s=this.ram,n=new u.Quetzal(t),r=n.memory,o=n.stacks,a=s.getUint8(17),c=0,l=0,f=[],p=[];if(s.getUint16(2)!==n.release||s.getUint16(28)!==n.checksum)return 0;for(;c<6;)if(s.getUint8(18+c)!==n.serial[c++])return 0;if(c=0,s.setUint8Array(0,this.origram),n.compressed)for(;c<r.length;)i=r[c++],0===i?l+=1+r[c++]:s.setUint8(l,i^this.origram[l++]);else s.setUint8Array(0,r);for(s.setUint8(17,a),c=6,i=o[c++]<<8|o[c++],e=Array.prototype.slice.apply(h(o.slice(c,i)));c<o.length;){for(f.unshift([o[c++]<<16|o[c++]<<8|o[c++],0,0,e.length,0,p.length]),f[0][1]=16&o[c]?-1:o[c+1],f[0][2]=15&o[c],c+=2,i=o[c++];i;)f[0][4]++,i>>=1;i=2*(o[c++]<<8|o[c++]),p=Array.prototype.slice.apply(h(o.slice(c,c+=2*f[0][2]))).concat(p),e=e.concat(h(o.slice(c,c+=i)))}return this.call_stack=f,this.l=p,this.s=e,this.pc=n.pc,this.update_header(),this.version3&&this.split_window(0),2},restore_undo:function(){if(0===this.undo.length)return 0;var t=this.undo.pop();return this.pc=t[0],t[2][17]=this.m.getUint8(17),this.ram.setUint8Array(0,t[2]),this.l=t[3],this.s=t[4],this.call_stack=t[5],this.variable(t[1],2),1},ret:function(t){var i=this.call_stack.shift(),e=i[1];this.pc=i[0],this.l=this.l.slice(this.l.length-i[5]),this.s.length=i[3],e>=0&&this.variable(e,0|t)},save:function(t){this.pc=t,this.fileref_create_by_prompt({func:"save",mode:1,usage:1})},save_file:function(t){var i,e,s,n,r,o=this.m,h=this.s,a=this.l,c=new u.Quetzal,l=[],f=0,p=this.call_stack.reverse(),g=[0,0,0,0,0,0];for(c.release=o.getUint16(2),c.serial=o.getUint8Array(18,6),c.checksum=o.getUint16(28),c.pc=t,c.compressed=1,i=0;i<this.staticmem;i++)s=o.getUint8(i)^this.origram[i],0===s?256===++f&&(l.push(0,255),f=0):(f&&(l.push(0,f-1),f=0),l.push(s));for(c.memory=l,g.push(p[0][3]>>8,255&p[0][3]),e=0;e<p[0][3];e++)g.push(h[e]>>8,255&h[e]);for(i=0;i<p.length;i++){for(n=p[i],r=(p[i+1]?p[i+1][3]:h.length)-n[3],g.push(n[0]>>16,n[0]>>8&255,255&n[0],n[2]|(n[1]<0?16:0),n[1]<0?0:n[1],(1<<n[4])-1,r>>8,255&r),e=a.length-n[5]-n[2];e<a.length-n[5];e++)g.push(a[e]>>8,255&a[e]);for(e=n[3];e<n[3]+r;e++)g.push(h[e]>>8,255&h[e]);
}return p.reverse(),c.stacks=g,c.write()},save_restore_handler:function(t){var i,e,s,n=this.m,r=this.Glk,o=0,h=[];t&&("save"===this.fileref_data.func?(r.glk_put_buffer_stream(t,new Uint8Array(this.save_file(this.pc))),o=1):(h=new Uint8Array(131072),r.glk_get_buffer_stream(t,h),o=this.restore_file(h.buffer)),r.glk_stream_close(t)),this.version3?(i=n.getUint8(this.pc++),e=128&i,s=64&i?63&i:(i<<8|n.getUint8(this.pc++))<<18>>18,!o==!e&&(0===s||1===s?this.ret(s):this.pc+=s-2)):this.variable(n.getUint8(this.pc++),o)},save_undo:function(t,i){return this.undo.push([t,i,this.m.getUint8Array(0,this.staticmem),this.l.slice(),this.s.slice(),this.call_stack.slice()]),1},scan_table:function(t,i,e,s){s=s||130;var n=128&s?"getUint16":"getUint8";for(s&=127,e=i+e*s;i<e;){if(this.m[n](i)===t)return i;i+=s}return 0},set_attr:function(t,i){var e=this.objects+(this.version3?9:14)*t+i/8|0;this.ram.setUint8(e,this.m.getUint8(e)|128>>i%8)},set_family:function(t,i,e,s,n,r){var o=this.ram,h=this.objects;this.version3?(o.setUint8(h+9*t+4,i),e&&o.setUint8(h+9*e+6,s),n&&o.setUint8(h+9*n+5,r)):(o.setUint16(h+14*t+6,i),e&&o.setUint16(h+14*e+10,s),n&&o.setUint16(h+14*n+8,r))},test:function(t,i){return(t&i)===i},test_attr:function(t,i){return this.m.getUint8(this.objects+(this.version3?9:14)*t+i/8|0)<<i%8&128},variable:function(t,i){var e,s=void 0!==i;if(0===t){if(!s)return this.s.pop();this.s.push(i)}else if(--t<15){if(!s)return this.l[t];this.l[t]=i}else{if(e=this.globals+2*(t-15),!s)return this.m.getUint16(e);this.ram.setUint16(e,i)}return i},U2S:r,S2U:o}},{"../common/file.js":2,"../common/utils.js":3,"./opcodes.js":7}],9:[function(t,i,e){i.exports={init_text:function(){function t(t){for(var i=[[],[],[]],s=0;s<78;)i[s/26|0][s%26]=t[s++];i[2][1]=13,e.alphabets=i}function i(t){for(var i={13:"\r"},s={13:13},n=0;n<t.length;)i[155+n]=String.fromCharCode(t[n]),s[t[n]]=155+n++;for(n=32;n<127;)i[n]=String.fromCharCode(n),s[n]=n++;e.unicode_table=i,e.reverse_unicode_table=s}var e=this,s=this.m,n=!this.version3&&s.getUint16(52),r=this.extension_table(3),o=r&&s.getUint8(r++);this.abbr_addr=s.getUint16(24),t(n?s.getUint8Array(n,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ \r0123456789.,!?_#'\"/\\-:()",1)),i(r?s.getUint16Array(r,o):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1)),this.dictionaries={},this.dict=s.getUint16(8),this.parse_dict(this.dict)},decode:function(t,i){var e,s,n,r,o=this.m,h=t,u=[],a=0,c=0,l=[],f=[],p=0;if(this.jit[t])return this.jit[t];for(i=i?i+t:this.eof;t<i&&(e=o.getUint16(t),t+=2,u.push(e>>10&31,e>>5&31,31&e),!(32768&e)););for(;a<u.length;){if(s=u[a++],0===s)l.push(32);else if(s<4)n=1,l.push(-1),f.push("+this.abbr("+(32*(s-1)+u[a++])+")+");else if(s<6)c=s;else if(2===c&&6===s){if(a+1<u.length)if(r=u[a++]<<5|u[a++],r<768)l.push(r);else{for(r-=767,p+=r,e=a,a=a%3+3;r--;)l.push(-1),f.push(String.fromCharCode(u[a]<<10|u[a+1]<<5|u[a+2])),u[a++]=u[a++]=u[a++]=32;a=e}}else s<32&&l.push(this.alphabets[c][s-6]);c=c<4?0:c-3,a%3===0&&(a+=p,p=0)}return l=this.zscii_to_text(l,f),n&&(l={toString:Function('return"'+l.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\r/g,"\\r").replace(/\uE000/g,'"')+'"').bind(this)}),h>=this.staticmem&&(this.jit[h]=l),l},encode:function(t){for(var i,e,s=this.alphabets,n=[],r=this.version3?6:9,o=0,h=[];n.length<r;)i=t[o++],32===i?n.push(0):(e=s[0].indexOf(i))>=0?n.push(e+6):(e=s[1].indexOf(i))>=0?n.push(4,e+6):(e=s[2].indexOf(i))>=0?n.push(5,e+6):(e=this.reverse_unicode_table[i])?n.push(5,6,e>>5,31&e):void 0===i&&n.push(5);for(n.length=r,o=0;o<r;)h.push(n[o++]<<2|n[o]>>3,(7&n[o++])<<5|n[o++]);return h[h.length-2]|=128,h},zscii_to_text:function(t,i){for(var e,s=0,n=t.length,r=0,o="";s<n;)e=t[s++],e===-1&&(o+=i[r++]),(e=this.unicode_table[e])&&(o+=e);return o},text_to_zscii:function(t,i){for(var e,s=[],n=0,r=t.length;n<r;)e=t.charCodeAt(n++),i||(e=this.reverse_unicode_table[e]||63),s.push(e);return s},parse_dict:function(t){var i,e,s=this.m,n=t,r={},o=s.getUint8(t++);for(r.separators=Array.prototype.slice.call(s.getUint8Array(t,o)),t+=o,i=s.getUint8(t++),e=t+2+i*s.getUint16(t),t+=2;t<e;)r[Array.prototype.toString.call(s.getUint8Array(t,this.version3?4:6))]=t,t+=i;return this.dictionaries[n]=r,r},abbr:function(t){return this.decode(2*this.m.getUint16(this.abbr_addr+2*t))},tokenise:function(t,i,e,s){e=e||this.dict,e=this.dictionaries[e]||this.parse_dict(e);var n,r,o,h,u=this.m,a=this.ram,c=1e3,l=1,f=e.separators,p=[],g=0;for(this.version3||(c=u.getUint8(t+l++)+2);l<c&&(n=u.getUint8(t+l),0!==n);)32===n||f.indexOf(n)>=0?(32!==n&&p.push([[n],l]),r=null):(r||(p.push([[],l]),r=p[p.length-1][0]),r.push(n)),l++;for(o=Math.min(p.length,u.getUint8(i));g<o;)h=e[""+this.encode(p[g][0])],s&&!h||(a.setUint16(i+2+4*g,h||0),a.setUint8(i+4+4*g,p[g][0].length),a.setUint8(i+5+4*g,p[g][1])),g++;a.setUint8(i+1,g)}}},{}]},{},[4])(4)});
